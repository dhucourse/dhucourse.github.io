import{j,_ as de,r as C,k as Q,o as ue,l as ge,u as ve,a as u,b as g,d as a,g as q,m as A,n as fe,p as he,q as Y,F as m,s as p,t as l,i as me,x as _,v as X,h as pe,y as _e,E as R}from"./index-CnmwwGkb.js";import{g as ke,a as O}from"./course-BPG2nUBP.js";import{b as ye,l as we,d as Ce}from"./comment-C4UYBfxe.js";const Se=()=>j.get("/school/list?type=0"),be=()=>j.get("/school/list?type=1"),xe={class:"page-container"},Ae={class:"top-nav"},Re={class:"nav-center"},Oe={class:"search-box"},$e=["onMousedown","onClick"],Te={class:"item-title"},Ve={class:"item-meta"},Me={class:"main-content"},Be={class:"course-categories"},Ie={class:"category-tabs"},Le=["onClick"],Ee={key:0,class:"college-list"},Fe=["onClick"],Ne={class:"college-courses"},De=["onClick"],Ke={key:1,class:"general-categories"},Pe=["onClick"],qe={class:"college-courses"},Ue=["onClick"],He={key:0,class:"course-detail"},Je={class:"course-header"},We={class:"course-title-wrap"},ze={class:"course-meta"},Ge={class:"teacher-tags"},Qe={key:0},Ye={class:"course-summary"},Xe={class:"rating-badge",title:"ç»¼åˆè¯„åˆ†"},Ze={class:"rating-number"},je={class:"comment-badge",title:"è¯„è®ºæ•°"},es={class:"comment-number"},ss={class:"course-stats"},ts={class:"stat-item"},ns={class:"stat-value"},as={class:"stat-item"},os={class:"stat-value"},rs={class:"stat-item"},is={class:"stat-value"},ls={class:"reviews-section"},cs={class:"reviews-header"},ds={class:"review-header"},us={class:"review-info"},gs={class:"review-author"},vs={class:"review-semester"},fs={class:"review-teacher"},hs={class:"review-date"},ms={class:"review-main"},ps={class:"review-content"},_s={class:"review-ratings"},ks={class:"rating-item"},ys={class:"rating-stars"},ws={class:"rating-item"},Cs={class:"rating-stars"},Ss={class:"rating-item"},bs={class:"rating-stars"},xs={class:"review-footer"},As={class:"review-grade"},Rs={class:"grade"},Os={class:"review-actions"},$s={class:"vote-buttons"},Ts=["disabled","onClick"],Vs=["disabled","onClick"],Ms={key:1,class:"course-placeholder"},Z="comment_votes",Bs={__name:"index",setup(Is){C(14930),C("æ¬¢è¿å›æ¥! è¯¾ç¨‹åˆ—è¡¨å·²æ›´æ–°è‡³24å¹´ç§‹å­£. æš‘æœŸæ„‰å¿«!");const S=C(""),T=C([]),b=C([]),x=C(!1);let k=null;function F(t=!1){if(!S.value){b.value=[],x.value=!1;return}const n=()=>{const e=String(S.value).toLowerCase().trim();if(!e){b.value=[],x.value=!1;return}const s=T.value.filter(c=>{const f=(c.name||c.cname||"").toString().toLowerCase(),o=(c.code||c.cno||c.kch||"").toString().toLowerCase();return f.includes(e)||o.includes(e)});b.value=s.slice(0,30),x.value=b.value.length>0};if(t){k&&(clearTimeout(k),k=null),n();return}k&&clearTimeout(k),k=setTimeout(()=>{n(),k=null},260)}async function U(t){if(!t)return;const n=t.name||t.cname||"";S.value=n;for(const e of w)e.isOpen=!1;for(const e of y)e.isOpen=!1;x.value=!1;try{await N(t)}finally{S.value="",b.value=[],x.value=!1}}const ee=[{id:"general",name:"é€šè¯†è¯¾ç¨‹"},{id:"college",name:"å­¦é™¢è¯¾ç¨‹"}],h=C("general"),y=Q([]),V=C(null),w=Q([]),r=C(null);function se(t){const n=w.find(e=>e.id===t);n&&(n.isOpen=!n.isOpen,n.isOpen&&n.courses.length===0&&O(n.id).then(e=>{e&&Array.isArray(e.data)&&(n.courses=e.data.map(s=>({id:s.id,name:s.cname,code:s.code,credits:s.credit||0,teachers:s.teachers||"æœªçŸ¥",semester:s.semester||"æœªçŸ¥",description:s.description||"æ— æè¿°",recommendRating:s.recommendrating||0,contentRating:s.contentrating||0,workloadRating:s.workloadrating||0,examRating:s.examrating||0,numOfComment:s.numofcomment||0,category:s.category||"æ— åˆ†ç±»",sname:s.sname})))}))}function te(t){const n=y.find(e=>e.id===t);n&&(n.isOpen=!n.isOpen,n.isOpen&&n.courses.length===0&&O(n.id).then(e=>{e&&Array.isArray(e.data)&&(n.courses=e.data.map(s=>({id:s.id,name:s.cname,code:s.code,credits:s.credit||0,teachers:s.teachers||"æœªçŸ¥",semester:s.semester||"æœªçŸ¥",description:s.description||"æ— æè¿°",recommendRating:s.recommendrating||0,contentRating:s.contentrating||0,workloadRating:s.workloadrating||0,examRating:s.examrating||0,numOfComment:s.numofcomment||0,category:s.category||"æ— åˆ†ç±»",sname:s.sname})))}))}function ne(t){const n=String(t);console.log(n);for(const e of w){const s=e.courses&&e.courses.find(c=>String(c.id)===n);if(s)return s}for(const e of y){const s=e.courses&&e.courses.find(c=>String(c.id)===n);if(s)return s}return null}function M(t){return{id:t.id,name:t.cname||t.name||t.title||"",code:t.code||t.cno||t.kch||t.kcno||"",credits:t.credit||t.credits||0,teachers:t.teachers||t.teacher||"æœªçŸ¥",semester:t.semester||"æœªçŸ¥",description:t.description||"æ— æè¿°",recommendRating:t.recommendrating||t.recommendRate||0,contentRating:t.contentrating||0,workloadRating:t.workloadrating||0,examRating:t.examrating||0,numOfComment:t.numofcomment||t.numOfComment||0,category:t.category||t.categoryId||t.cid||"",sname:t.sname}}async function ae(t,n,e=!1){const s=["sid","schoolId","collegeId","pubid","category","categoryId"];for(const c of s)if(n&&n[c]){const f=n[c],o=w.find(v=>String(v.id)===String(f));if(o){if(o.isOpen=!0,h.value="college",!o.courses||o.courses.length===0)try{const v=await O(o.id);v&&Array.isArray(v.data)&&(o.courses=v.data.map(M))}catch(v){console.warn("load college courses failed",v)}return}const d=y.find(v=>String(v.id)===String(f));if(d){if(d.isOpen=!0,h.value="general",!d.courses||d.courses.length===0)try{const v=await O(d.id);v&&Array.isArray(v.data)&&(d.courses=v.data.map(M))}catch(v){console.warn("load category courses failed",v)}return}}for(const c of w)if(c.courses&&c.courses.find(f=>String(f.id)===String(t))){c.isOpen=!0,h.value="college";return}for(const c of y)if(c.courses&&c.courses.find(f=>String(f.id)===String(t))){c.isOpen=!0,h.value="general";return}if(e){const c=[...w.map(f=>({type:"college",id:f.id})),...y.map(f=>({type:"category",id:f.id}))];for(const f of c)try{if(f.type==="college"){const o=w.find(d=>String(d.id)===String(f.id));if(!o)continue;if(o.courses&&o.courses.find(d=>String(d.id)===String(t))){o.isOpen=!0,h.value="college";return}if(!o.courses||o.courses.length===0){const d=await O(o.id);if(d&&Array.isArray(d.data)&&(o.courses=d.data.map(M),o.courses.find(v=>String(v.id)===String(t)))){o.isOpen=!0,h.value="college";return}}}else{const o=y.find(d=>String(d.id)===String(f.id));if(!o)continue;if(o.courses&&o.courses.find(d=>String(d.id)===String(t))){o.isOpen=!0,h.value="general";return}if(!o.courses||o.courses.length===0){const d=await O(o.id);if(d&&Array.isArray(d.data)&&(o.courses=d.data.map(M),o.courses.find(v=>String(v.id)===String(t)))){o.isOpen=!0,h.value="general";return}}}}catch(o){console.warn("force parent load failed for",f,o);continue}}}async function N(t){let n,e=null;typeof t=="object"&&t!==null?(e=t,n=e.id):n=t,V.value=n,e||(e=ne(n));try{await ae(n,e||{},!0)}catch(s){console.warn("expandToCourse failed",s)}!e&&Array.isArray(T.value)&&(e=T.value.find(s=>String(s.id)===String(n))||null),e=e||{id:n},r.value={id:e.id,name:e.name||e.cname||e.title||"",code:e.code||e.cno||e.kch||"",teacher:e.teacher||e.teachers||"",teachers:[],credits:e.credits||e.credit||"",rating:0,recommendRate:0,workload:"",reviews:[],sname:e.sname};try{const s=await ye(n);if(s&&Array.isArray(s.data)){const c=s.data;let f=0,o=0,d=0,v=0;const E=c.map(i=>(typeof i.score=="number"&&(f+=i.score,o++),i.isrecommend===1&&d++,typeof i.workloadrating=="number"&&(v+=i.workloadrating),{id:i.id,author:i.uid?`ç”¨æˆ·${i.uid}`:"åŒ¿åç”¨æˆ·",semester:i.semester||"",teacher:i.teacher||"",date:i.createtime||i.updatetime||"",content:i.content||i.title||"",grade:i.score?String(i.score):"",ratings:{content:i.contentrating||0,workload:i.workloadrating||0,exam:i.examrating||0},likes:i.likes||0,dislikes:i.dislikes||0,isRecommended:i.isrecommend===1,sname:i.sname}));r.value.reviews=E;try{const i=new Set;e&&(e.teacher||e.teachers)&&(Array.isArray(e.teachers)?e.teachers.forEach($=>$&&i.add(String($).trim())):e.teacher&&i.add(String(e.teacher).trim())),E.forEach($=>{$.teacher&&i.add(String($.teacher).trim())});const P=Array.from(i).filter(Boolean);r.value.teachers=P,r.value.teacher=P.length>0?P[0]:r.value.teacher||""}catch(i){console.warn("extract teachers failed",i)}if(o>0&&(r.value.rating=Number((f/o).toFixed(1))),r.value.recommendRate=E.length>0?Math.round(d/E.length*100):0,c.length>0&&v>0){const i=v/c.length;i<=2?r.value.workload="è¾ƒè½»":i<4?r.value.workload="ä¸­ç­‰":r.value.workload="è¾ƒé‡"}else r.value.workload=""}}catch(s){console.error("getCommentByCourseId error",s)}try{await _e();const s=document.querySelector(".course-categories a.active");s&&typeof s.scrollIntoView=="function"&&s.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})}catch(s){console.warn("scrollIntoView failed",s)}}function H(t){if(!t)return"";const n=t.code;if(n!=null&&String(n)!==""){const e=String(n);return/^\d+$/.test(e)?e.padStart(6,"0"):e}return String(t.id||"").padStart(6,"0")}function oe(){B.push("/post")}function re(){r.value&&(window.location.href=`/post?cid=${V.value}`)}const ie=()=>{B.push("/")};ue(async()=>{const t=await Se();t&&Array.isArray(t.data)&&y.splice(0,y.length,...t.data.map(e=>({id:e.id,name:e.sname,isOpen:!1,courses:[]})));const n=await be();n&&Array.isArray(n.data)&&w.splice(0,w.length,...n.data.map(e=>({id:e.id,name:e.sname,isOpen:!1,courses:[]})));try{const e=await ke();e&&Array.isArray(e.data)&&(T.value=e.data.map(s=>({id:s.id,name:s.cname,teacher:s.teacher||"æœªçŸ¥",code:s.code||"",credit:s.credit,sname:s.sname||""})))}catch(e){console.warn("getAllCourse failed",e)}}),ge(()=>{k&&(clearTimeout(k),k=null)});const B=me(),J=ve();function D(){try{return JSON.parse(localStorage.getItem(Z)||"{}")}catch{return{}}}function W(t){localStorage.setItem(Z,JSON.stringify(t))}const K=C({});function z(t,n=!0){K.value[t]=n}function G(t){delete K.value[t]}function I(t){return!!K.value[t]}function L(t){return D()[t]||null}async function le(t){if(!J.token){R.warning("è¯·å…ˆç™»å½•"),B.push("/login");return}const n=L(t.id);if(n==="like"){R.info("ä½ å·²èµè¿‡è¯¥è¯„è®º");return}if(!I(t.id)){z(t.id,!0);try{const e=await we(t.id);t.likes=(t.likes||0)+1,n==="dislike"&&(t.dislikes=Math.max((t.dislikes||1)-1,0));const s=D();s[t.id]="like",W(s)}catch(e){console.error("likeComment error",e),R.error("ç‚¹èµå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•")}finally{G(t.id)}}}async function ce(t){if(!J.token){R.warning("è¯·å…ˆç™»å½•"),B.push("/login");return}const n=L(t.id);if(n==="dislike"){R.info("ä½ å·²è¸©è¿‡è¯¥è¯„è®º");return}if(!I(t.id)){z(t.id,!0);try{const e=await Ce(t.id);t.dislikes=(t.dislikes||0)+1,n==="like"&&(t.likes=Math.max((t.likes||1)-1,0));const s=D();s[t.id]="dislike",W(s)}catch(e){console.error("dislikeComment error",e),R.error("è¸©å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•")}finally{G(t.id)}}}return(t,n)=>(g(),u("div",xe,[a("nav",Ae,[a("div",{class:"nav-left"},[a("div",{onClick:ie,class:"logo",style:{cursor:"pointer"}},"è¯¾ç¨‹æµ‹è¯„@DHU")]),a("div",Re,[a("div",Oe,[q(a("input",{type:"text",placeholder:"æœç´¢è¯¾ç¨‹åç§°æˆ–æ•™å¸ˆ","onUpdate:modelValue":n[0]||(n[0]=e=>S.value=e),onInput:F,onFocus:n[1]||(n[1]=e=>x.value=S.value.length>0),onKeyup:n[2]||(n[2]=he(e=>F(!0),["enter"]))},null,544),[[fe,S.value]]),a("button",{class:"search-btn",onClick:n[3]||(n[3]=e=>F(!0))},"æœç´¢"),x.value&&b.value.length>0?(g(),u("div",{key:0,class:"search-dropdown",onMousedown:n[4]||(n[4]=Y(()=>{},["stop"]))},[(g(!0),u(m,null,p(b.value,e=>(g(),u("div",{class:"search-item",key:e.id,onMousedown:Y(s=>U(e),["prevent"]),onClick:s=>U(e)},[a("div",Te,l(e.name),1),a("div",Ve," è¯¾ç¨‹ç¼–ç : "+l(e.code)+" Â |Â  "+l(e.sname),1)],40,$e))),128))],32)):A("",!0)])]),a("div",{class:"nav-right"},[a("button",{class:"publish-btn",onClick:oe},"å‘å¸ƒæµ‹è¯„")])]),a("div",Me,[a("div",Be,[a("div",Ie,[(g(),u(m,null,p(ee,e=>a("div",{class:_(["tab",{active:h.value===e.id}]),key:e.id,onClick:s=>h.value=e.id},l(e.name),11,Le)),64))]),h.value==="college"?(g(),u("div",Ee,[(g(!0),u(m,null,p(w,e=>(g(),u("div",{key:e.id,class:"college-item"},[a("div",{class:"college-header",onClick:s=>se(e.id)},[a("span",null,l(e.name),1),a("span",{class:_(["arrow",{"arrow-down":e.isOpen}])},"â–¶",2)],8,Fe),q(a("div",Ne,[(g(!0),u(m,null,p(e.courses,s=>(g(),u("a",{key:s.id,onClick:c=>N(s.id),class:_({active:V.value===s.id})},l(H(s))+"-"+l(s.name),11,De))),128))],512),[[X,e.isOpen]])]))),128))])):A("",!0),h.value==="general"?(g(),u("div",Ke,[(g(!0),u(m,null,p(y,e=>(g(),u("div",{key:e.id,class:"college-item"},[a("div",{class:"college-header",onClick:s=>te(e.id)},[a("span",null,l(e.name),1),a("span",{class:_(["arrow",{"arrow-down":e.isOpen}])},"â–¶",2)],8,Pe),q(a("div",qe,[(g(!0),u(m,null,p(e.courses,s=>(g(),u("a",{key:s.id,onClick:c=>N(s.id),class:_({active:V.value===s.id})},l(H(s))+"-"+l(s.name),11,Ue))),128))],512),[[X,e.isOpen]])]))),128))])):A("",!0)]),r.value?(g(),u("div",He,[a("div",Je,[a("div",We,[a("h1",null,l(r.value.name),1),a("div",ze,[n[5]||(n[5]=a("span",{class:"teacher-label"},"æ•™å¸ˆ: ",-1)),a("span",Ge,[(g(!0),u(m,null,p(r.value.teachers,e=>(g(),u("span",{class:"teacher-tag",key:e},l(e),1))),128)),!r.value.teachers||r.value.teachers.length===0?(g(),u("span",Qe,l(r.value.teacher||"æœªçŸ¥"),1)):A("",!0)]),a("span",null,"è¯¾ç¨‹å·: "+l(r.value.code),1),a("span",null,"å­¦åˆ†: "+l(r.value.credits),1)])]),a("div",Ye,[a("div",Xe,[a("div",Ze,l(r.value.rating||"â€”"),1),n[6]||(n[6]=a("div",{class:"rating-meta"},[a("div",{class:"rating-label"},"ç»¼åˆè¯„åˆ†")],-1))]),a("div",je,[n[7]||(n[7]=a("span",{class:"comment-icon"},"ğŸ’¬",-1)),a("span",es,"å…±"+l(r.value.reviews.length)+"æ¡è¯„è®º",1)])])]),a("div",ss,[a("div",ts,[a("div",ns,l(r.value.reviews.length>0?(r.value.reviews.reduce((e,s)=>e+s.ratings.content,0)/r.value.reviews.length).toFixed(1):0),1),n[8]||(n[8]=a("div",{class:"stat-label"},"è¯¾ç¨‹å†…å®¹",-1))]),a("div",as,[a("div",os,l(r.value.reviews.length>0?(r.value.reviews.reduce((e,s)=>e+s.ratings.workload,0)/r.value.reviews.length).toFixed(1):0),1),n[9]||(n[9]=a("div",{class:"stat-label"},"å·¥ä½œé‡",-1))]),a("div",rs,[a("div",is,l(r.value.reviews.length>0?(r.value.reviews.reduce((e,s)=>e+s.ratings.exam,0)/r.value.reviews.length).toFixed(1):0),1),n[10]||(n[10]=a("div",{class:"stat-label"},"è€ƒæ ¸éš¾åº¦",-1))])]),a("div",ls,[a("div",cs,[a("h2",null,"è¯¾ç¨‹è¯„ä»· ("+l(r.value.reviews.length)+")",1),a("button",{class:"review-course-btn",onClick:re}," è¯„ä»·è¯¾ç¨‹ ")]),(g(!0),u(m,null,p(r.value.reviews,e=>(g(),u("div",{class:"review-card",key:e.id},[a("div",ds,[a("div",us,[a("span",gs,l(e.author),1),a("span",vs,l(e.semester),1),a("span",fs,"æˆè¯¾æ•™å¸ˆ: "+l(e.teacher),1)]),a("div",hs,l(e.date),1)]),a("div",ms,[a("div",ps,l(e.content),1),a("div",_s,[a("div",ks,[n[11]||(n[11]=a("div",{class:"rating-label"},"è¯¾ç¨‹å†…å®¹",-1)),a("div",ys,[(g(),u(m,null,p(5,s=>a("span",{key:s,class:_(["star",s<=e.ratings.content?"filled":""])}," â˜… ",2)),64))])]),a("div",ws,[n[12]||(n[12]=a("div",{class:"rating-label"},"å·¥ä½œé‡",-1)),a("div",Cs,[(g(),u(m,null,p(5,s=>a("span",{key:s,class:_(["star",s<=e.ratings.workload?"filled":""])}," â˜… ",2)),64))])]),a("div",Ss,[n[13]||(n[13]=a("div",{class:"rating-label"},"è€ƒæ ¸",-1)),a("div",bs,[(g(),u(m,null,p(5,s=>a("span",{key:s,class:_(["star",s<=e.ratings.exam?"filled":""])}," â˜… ",2)),64))])])])]),a("div",xs,[a("div",As,[n[14]||(n[14]=pe(" æˆç»©: ",-1)),a("span",Rs,l(e.grade),1)]),a("div",Os,[a("span",{class:_(["recommend",{recommended:e.isRecommended}])},l(e.isRecommended?"æ¨è":"ä¸æ¨è"),3),a("div",$s,[a("button",{class:_(["vote-btn like",{voted:L(e.id)==="like"}]),disabled:I(e.id),onClick:s=>le(e)}," ğŸ‘ "+l(e.likes),11,Ts),a("button",{class:_(["vote-btn dislike",{voted:L(e.id)==="dislike"}]),disabled:I(e.id),onClick:s=>ce(e)}," ğŸ‘ "+l(e.dislikes),11,Vs)])])])]))),128))])])):A("",!0),r.value?A("",!0):(g(),u("div",Ms,[...n[15]||(n[15]=[a("div",{class:"placeholder-inner"},[a("h2",null,"æœªé€‰æ‹©è¯¾ç¨‹"),a("p",null,"è¯·åœ¨å·¦ä¾§è¯¾ç¨‹åˆ—è¡¨ä¸­é€‰æ‹©ä¸€é—¨è¯¾ç¨‹ä»¥æŸ¥çœ‹è¯„ä»·è¯¦æƒ…ã€‚"),a("p",null,"ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸Šæ–¹æœç´¢æ¡†è¾“å…¥è¯¾ç¨‹åæˆ–æ•™å¸ˆï¼ŒæŒ‰å›è½¦æˆ–ç‚¹å‡»æœç´¢æŸ¥çœ‹ç»“æœã€‚")],-1)])]))])]))}},Ns=de(Bs,[["__scopeId","data-v-5d7e5569"]]);export{Ns as default};
